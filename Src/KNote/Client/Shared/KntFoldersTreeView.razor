@inject AppState appState
@inject TooltipService tooltipService
@implements IDisposable


<RadzenTree Data=@FoldersInfo  Change=@OnChange>
    <RadzenTreeLevel 
        TextProperty="Name" 
        ChildrenProperty="ChildFolders"     
        Expanded=@ShouldExpanded 
        Selected=@ShouldSelected
        HasChildren=@(f => (f as FolderDto).ChildFolders.Any()) >
            <Template>       
                <RadzenIcon Icon="folder" Style="color: lightgray"/> @context.Text
                @if (EditMode)
                {
                    <span>
                        <div class="pl-3" style="font-size:10px">
                            <RadzenIcon Icon="edit" @onclick="@(() => OnFolderEdit((FolderDto)context.Value))"
                                MouseEnter="@(args => tooltipService.Open(args, "Edit folder ...", new TooltipOptions(){ Position = TooltipPosition.Top }) )" Class="mr-0 mb-0" />
                            <RadzenIcon Icon="delete" @onclick="@(() => OnFolderDelete((FolderDto)context.Value))"
                                MouseEnter="@(args => tooltipService.Open(args, "Delete folder ...", new TooltipOptions(){ Position = TooltipPosition.Right }) )" />
                        </div>
                    </span>                    
                }
        </Template>
    </RadzenTreeLevel>            
</RadzenTree>


@code {
    [Parameter] public List<FolderDto> FoldersInfo { get; set; }
    [Parameter] public EventCallback<FolderDto> FolderSelected { get; set; }
    [Parameter] public EventCallback<FolderDto> FolderDelete { get; set; }
    [Parameter] public EventCallback<FolderDto> FolderEdit { get; set; }
    [Parameter] public bool EditMode { get; set; }    

    protected override void OnInitialized()
    {
        appState.OnChange += StateHasChanged;

        base.OnInitialized();
    }

    public void Dispose()
    {
        appState.OnChange -= StateHasChanged;
    }

    protected async Task OnFolderSelected(FolderDto folder)
    {
        await FolderSelected.InvokeAsync(folder);
    }

    private async Task OnFolderDelete(FolderDto folder)
    {
        await FolderDelete.InvokeAsync(folder);
    }

    private async Task OnFolderEdit(FolderDto folder)
    {
        await FolderEdit.InvokeAsync(folder);
    }

    bool ShouldSelected(object data)
    {
        if(string.IsNullOrEmpty(appState.SelectedFolder.Name))
            return false; 

        var folder = data as FolderDto;
        return folder.Name == appState.SelectedFolder.Name;              
    }

    // TODO: !!! refactor (is not working when level folder > 1)
    bool ShouldExpanded(object data)
    {
        if(appState.SelectedFolder == null)
            return false; 

        if(appState.SelectedFolder.ParentId == null)
            return false; 

        var folder = data as FolderDto;
        return folder.FolderId == appState.SelectedFolder.ParentId;        
    }

    async void OnChange(TreeEventArgs args)
    {
        var folder = args.Value as FolderDto;
        await FolderSelected.InvokeAsync(folder);        
    }

}
@page "/users/new"

@inject IWebApiService webApiService
@inject NavigationManager navigationManager
@inject NotificationService NotificationService

@inject Radzen.DialogService dialogService

@attribute [Authorize(Roles = "Admin")]

<UserForm Title="New User" OnValidSubmit="OnNew" OnExit="OnExit" User="user"></UserForm>

@code {
    private UserDto user = new UserDto();

    private async Task OnNew()
    {
        if (!user.IsValid())            
            NotificationService.Notify(new NotificationMessage { Severity = NotificationSeverity.Error, Summary = "Save user", Detail =  user.GetErrorMessage(), Duration = 12000 });
        else
        {
            var result = await webApiService.Users.SaveAsync(user);
            if (!result.IsValid)                
                NotificationService.Notify(new NotificationMessage { Severity = NotificationSeverity.Error, Summary = "Save user", Detail =  result.Message, Duration = 12000 });
            else
            {
                NotificationService.Notify(new NotificationMessage { Severity = NotificationSeverity.Success, Summary = "New user", Detail =  "The user has been created.", Duration = 3000 });
                dialogService.Close(user);
            }            
        }
    }

    private void OnExit()
    {        
        dialogService.Close(null);
    }

}

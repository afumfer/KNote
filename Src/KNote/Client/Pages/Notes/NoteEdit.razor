@page "/notes/edit/{NoteId}/{PageReturn}"

@inject AppState appState
@inject IWebApiService webApiService
@inject NavigationManager navigationManager
@inject NotificationService notificationService

@implements IDisposable

@attribute [Authorize(Roles = "Staff, ProjecManager, Admin")]

@if (showForm)
{
    <NoteForm Title="Note edit" Note="note" OnValidSubmit="OnSave" OnValidSubmitWithNew="OnSaveAndNew" OnExit="OnExit" NoteTypes="noteTypes"></NoteForm>
}
else
{
    <text>Loading ... </text>
}

@code {

    [Parameter] public string NoteId { get; set; }
    [Parameter] public string PageReturn { get; set; }

    private NoteDto note;
    private bool showForm = false;
    private List<NoteTypeDto> noteTypes;

    #region Initialize and Dispose

    protected async override Task OnInitializedAsync()
    {
        appState.OnChange += StateHasChanged;

        var result = await webApiService.NoteTypes.GetAllAsync();
        if (!result.IsValid)
        {
            notificationService.Notify(new NotificationMessage { Severity = NotificationSeverity.Error, Summary = "Get note types.", Detail =  result.Message, Duration = 12000 });
            navigationManager.NavigateTo("index");
        }
        else
        {
            noteTypes = result.Entity;

            await GetNote();

            showForm = true;
        }

        if (PageReturn == null)
            PageReturn = "index";
        else if (PageReturn == "tree")
            PageReturn = "notes/tree";

        await base.OnInitializedAsync();
    }

    public void Dispose()
    {
        appState.OnChange -= StateHasChanged;
    }

    #endregion

    #region Data methods

    private async Task GetNote()
    {
        var result = await webApiService.Notes.GetAsync(Guid.Parse(NoteId));
        if (!result.IsValid)
        {            
            notificationService.Notify(new NotificationMessage { Severity = NotificationSeverity.Error, Summary = "Get note.", Detail =  result.Message, Duration = 12000 });
            navigationManager.NavigateTo("index");
        }
        else
        {
            note = result.Entity;
            showForm = true;
        }
    }

    private async Task SaveNote()
    {
        var result = await webApiService.Notes.SaveAsync(note);
        if (!result.IsValid)
        {            
            notificationService.Notify(new NotificationMessage { Severity = NotificationSeverity.Error, Summary = "Save note.", Detail =  result.Message, Duration = 12000 });
        }
        else
        {
            note = result.Entity;            
            notificationService.Notify(new NotificationMessage { Severity = NotificationSeverity.Success, Summary = "Save note.", Detail =  "The note has been saved.", Duration = 3000 });
        }
    }

    private async Task GetNewNote()
    {
        var result = await webApiService.Notes.NewAsync();
        if (!result.IsValid)
        {
            notificationService.Notify(new NotificationMessage { Severity = NotificationSeverity.Error, Summary = "New note.", Detail =  result.Message, Duration = 12000 });            
        }
        else
        {
            note = result.Entity;
            if (appState.SelectedFolder != null)
            {
                note.FolderDto = appState.SelectedFolder.GetSimpleDto<FolderDto>();
                note.FolderId = appState.SelectedFolder.FolderId;
            }
            showForm = true;
        }
    }

    #endregion

    #region Events managment

    private async Task OnSave()
    {
        await SaveNote();
    }

    private async Task OnSaveAndNew()
    {
        await SaveNote();
        await GetNewNote();
    }

    private void OnExit()
    {
        navigationManager.NavigateTo(PageReturn);
    }

    #endregion

}

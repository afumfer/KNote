@page "/notes/new/{PageReturn}"

@implements IDisposable

@inject IStore store
@*@inject NavigationManager navigationManger*@
@*@inject NotificationService notificationService*@

@attribute [Authorize(Roles = "Staff, ProjecManager, Admin")]


@if (showForm)
{
    <NoteForm Title=@title Note="note" OnValidSubmit="OnSave" OnValidSubmitWithNew="OnSaveAndNew" OnExit="OnExit" NoteTypes="noteTypes"></NoteForm>
}
else
{
    <text>Loading ... </text>
}

@code {

    [Parameter] public string PageReturn { get; set; }

    private NoteDto note;
    private bool showForm = false;
    private List<NoteTypeDto> noteTypes = new List<NoteTypeDto>();
    private AppState appState;
    private string title = "Note new";

    #region Initialize and dispose

    protected async override Task OnInitializedAsync()
    {
        appState = store.AppState;
        appState.OnChange += StateHasChanged;

        var result = await store.NoteTypes.GetAllAsync();
        //if (!result.IsValid)
        //{
        //    notificationService.Notify(new NotificationMessage { Severity = NotificationSeverity.Error, Summary = "Get note types.", Detail =  result.Message, Duration = 12000 });
        //}
        //else
        //{
        //    noteTypes = result.Entity;
        //    await GetNewNote();
        //}
        if (result.IsValid)
        {
            noteTypes = result.Entity;
            await GetNewNote();
        }

        if (PageReturn == null)
            PageReturn = "index";
        else if (PageReturn == "tree")
            PageReturn = "notes/tree";

        await base.OnInitializedAsync();
    }

    public void Dispose()
    {
        appState.OnChange -= StateHasChanged;
    }

    #endregion

    #region Data methods

    private async Task GetNewNote()
    {
        var result = await store.Notes.NewAsync();
        //if (!result.IsValid)
        //{         
        //    notificationService.Notify(new NotificationMessage { Severity = NotificationSeverity.Error, Summary = "New note.", Detail =  result.Message, Duration = 12000 });
        //}
        //else
        //{
        //    note = result.Entity;
        //    if (appState.SelectedFolder != null)
        //    {
        //        note.FolderDto = appState.SelectedFolder.GetSimpleDto<FolderDto>();
        //        note.FolderId = appState.SelectedFolder.FolderId;
        //    }
        //    note.ContentType = "markdown";
        //    note.SetIsNew(true);
        //    showForm = true;
        //}
        if (result.IsValid)
        {
            note = result.Entity;
            if (appState.SelectedFolder != null)
            {
                note.FolderDto = appState.SelectedFolder.GetSimpleDto<FolderDto>();
                note.FolderId = appState.SelectedFolder.FolderId;
            }
            note.ContentType = "markdown";
            note.SetIsNew(true);
            showForm = true;
        }
    }

    private async Task SaveNote()
    {
        if (note.IsNew())
        {
            var result = await store.Notes.SaveAsync(note);

            //if (!result.IsValid)
            //{            
            //    notificationService.Notify(new NotificationMessage { Severity = NotificationSeverity.Error, Summary = "Save new note.", Detail =  result.Message, Duration = 12000 });
            //}
            //else
            //{
            //    var entitySaved = result.Entity;

            //    // TODO: Hack ... bucar una implementación más eficiente.
            //    //       Se refrescan valores asignados automáticamente
            //    //       en la capa de negocio.

            //    foreach (var atrSaved in entitySaved.KAttributesDto)
            //    {
            //        foreach (var atrEdit in note.KAttributesDto)
            //        {
            //            if (atrEdit.KAttributeId == atrSaved.KAttributeId)
            //            {
            //                atrEdit.NoteKAttributeId = atrSaved.NoteKAttributeId;
            //            }
            //        }
            //    }
            //    note.NoteNumber = entitySaved.NoteNumber;
            //    note.NoteId = entitySaved.NoteId;
            //    note.SetIsNew(false);
                             
            //    notificationService.Notify(new NotificationMessage { Severity = NotificationSeverity.Success, Summary = "New note.", Detail =  "The note has been created.", Duration = 3000 });
            //    title = "Note edit";
            //}

            if (result.IsValid)
            {
                var entitySaved = result.Entity;

                // TODO: Hack ... bucar una implementación más eficiente.
                //       Se refrescan valores asignados automáticamente
                //       en la capa de negocio.

                foreach (var atrSaved in entitySaved.KAttributesDto)
                {
                    foreach (var atrEdit in note.KAttributesDto)
                    {
                        if (atrEdit.KAttributeId == atrSaved.KAttributeId)
                        {
                            atrEdit.NoteKAttributeId = atrSaved.NoteKAttributeId;
                        }
                    }
                }
                note.NoteNumber = entitySaved.NoteNumber;
                note.NoteId = entitySaved.NoteId;
                note.SetIsNew(false);
                
                title = "Note edit";
            }
        }
        else
        {
            var result = await store.Notes.SaveAsync(note);

            //if (!result.IsValid)                            
            //    notificationService.Notify(new NotificationMessage { Severity = NotificationSeverity.Error, Summary = "New note.", Detail =  result.Message, Duration = 12000 });
            //else                            
            //    notificationService.Notify(new NotificationMessage { Severity = NotificationSeverity.Success, Summary = "New note.", Detail =  "The note has been created.", Duration = 3000 });
            
        }
    }

    #endregion

    #region Events managment

    private async Task OnSave()
    {
        await SaveNote();
    }

    private async Task OnSaveAndNew()
    {
        await SaveNote();
        await GetNewNote();
    }

    private void OnExit()
    {
        store.NavigateTo(PageReturn);
    }

    #endregion

}
